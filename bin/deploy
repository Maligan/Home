#!/bin/sh

CONFIG=.deploy
VERSION=0.1
DRY=

version() { 
	echo "`basename $0` v$VERSION"
}

header() {
	echo "$@"
}

usage() {
	echo "Usage: `basename $0` [OPTION]..."
	echo "Source '$CONFIG' script, sync files from current machine to server."
	echo
	echo "Options:"
	echo "    -n               preform a dry-run"
	echo "    -v VERSION       set swf file version"
}

abort() {
	test "$@" && echo "$@"
	exit 1
}

config_variable_check() {
	var_name=$1
	var_value=${!var_name}
	test "$var_value" || abort "Config '$CONFIG' variable $var_name is not defined."
}

config() {
	test -f $CONFIG	|| abort "Config '$CONFIG' not found."

	# Ignore rsync --include-from elements from config
	alias -- -=#
	alias -- +=#
	source ./$CONFIG || abort "Config '$CONFIG' eval error."
	unalias -- -
	unalias -- +

	config_variable_check "SSH_HOST"
	config_variable_check "SSH_PATH"
	config_variable_check "ASSET_SOURCE"
	config_variable_check "ASSET_TARGET"
	config_variable_check "SWF_SOURCE"
	config_variable_check "SWF_TARGET"

	ssh $SSH_HOST "test -d $SSH_PATH" || abort "Remote directory $SSH_HOST:$SSH_PATH doesn't exits."
}

#
# Deploy
#
while getopts "nv" opt; do
	case $opt in
		n) DRY=-n ;;
		*) usage; exit ;;
	esac
done


config
header "Deploy assets:"
rsync $DRY -ac -e ssh --out-format=' * %n' --prune-empty-dirs --include-from=$CONFIG $ASSET_SOURCE $ASSET_TARGET | sed '/\/$/d'

header "Deploy SWF:"
rsync $DRY -ac -e ssh --out-format=' * %n' $SWF_SOURCE $SWF_TARGET
